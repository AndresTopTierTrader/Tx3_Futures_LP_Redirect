const fs = require('fs');
const colors = require('colors');
const handleError = require('../handleError');
const handleFetch = require('../handleFetch');
const baseUrl = require('../baseUrl');
const getProject = require('../getProject');

const cleanDirectory = path => {
  if (!fs.existsSync(path)) {
    return;
  }

  // as safety precaution, only delete folders that match regex
  const regex = /^[a-z]{2}(-[A-Z]{2,4})?$/;

  const contents = fs.readdirSync(path);

  contents.forEach(name => {
    if (regex.test(name)) {
      fs.rmdirSync(`${path}/${name}`, { recursive: true });
    }
  });
};

const pull = async opt => {
  let path = opt.path;

  const project = await getProject(opt.apiKey);

  const projectLibrary = project.library;

  if (!path) {
    if (!projectLibrary) {
      console.log(
        colors.red(
          'There was a problem fetching your translations. Please try again in a moment.'
        )
      );
      return process.exit(1);
    }

    if (projectLibrary === 'i18next') {
      const hasAppDir =
        fs.existsSync(`${process.cwd()}/app`) ||
        fs.existsSync(`${process.cwd()}/src/app`);
      const usingAppRouter =
        hasAppDir &&
        (fs.existsSync(`${process.cwd()}/.next`) ||
          fs.existsSync(`${process.cwd()}/next.config.js`) ||
          fs.existsSync(`${process.cwd()}/next.config.ts`));

      if (usingAppRouter) {
        path = `${process.cwd()}/locales`;
      } else {
        path = `${process.cwd()}/public/locales`;
      }
    } else {
      path = `${process.cwd()}/messages`;
    }
  }

  const usingVersion = opt.version !== 'latest';

  let url = usingVersion
    ? `https://cdn.i18nexus.com/versions/${opt.version}/translations.json`
    : `${baseUrl}/project_resources/translations.json`;

  url += `?api_key=${opt.apiKey}`;

  console.log(`Downloading translations to ${path}...`);

  const response = await handleFetch(url);

  if (response.status !== 200) {
    return handleError(
      response,
      usingVersion
        ? 'There was a problem fetching your translations. Please ensure you are using the correct API key and a valid version number.'
        : 'There was a problem fetching your translations. Please try again in a moment.'
    );
  }

  const translations = await response.json();

  if (opt.clean) {
    cleanDirectory(path);
  }

  if (projectLibrary === 'next-intl') {
    for (let lng in translations) {
      fs.mkdirSync(path, { recursive: true });

      fs.writeFileSync(
        `${path}/${lng}.json`,
        JSON.stringify(translations[lng])
      );
    }
  } else {
    for (let lng in translations) {
      const lngFilePath = `${path}/${lng}`;
      fs.mkdirSync(lngFilePath, { recursive: true });

      for (let namespace in translations[lng]) {
        fs.writeFileSync(
          `${lngFilePath}/${namespace}.json`,
          JSON.stringify(translations[lng][namespace])
        );
      }
    }
  }

  console.log(colors.green('Translations downloaded successfully.'));
};

module.exports = pull;
